#!/bin/bash
DIR=$(readlink -f "$(dirname "$0")")
INSTALLATION="$HOME/.dfiles"
BRANCH="installation"
COLORSCHEME="$1"

if [[ -z "$COLORSCHEME" ]]; then
  echo "Select a file under \`colorschemes\` and pass it as first argument"
  exit 1
fi

cd "$DIR" || exit 1

function setup_local_installation() {
  if git show-ref --verify --quiet refs/heads/$BRANCH; then
    git branch "$BRANCH" > /dev/null 2> /dev/null
    git worktree add "$INSTALLATION" "$BRANCH" > /dev/null 2> /dev/null
  fi
}

function install_packages() {
  cd "$INSTALLATION" || exit 1

  for package in $(fd --type d --max-depth=1 --exclude "colorschemes"); do
    package_dirs=$(fd -H --type d . "$package" | sed "s|^$package/|$HOME/|" | uniq | sort)
    if [[ -n "$package_dirs" ]]; then
      echo "$package_dirs" | xargs mkdir -p
    fi
    stow -t "$HOME" -S "$package"
  done
}


function build_packages() {
  cd "$INSTALLATION" || exit 1
  scheme="$INSTALLATION/colorschemes/$COLORSCHEME.yml"

  stat "$scheme" > /dev/null || exit 1

  for template in $(fd -H -e mustache --exclude "colorschemes" .); do
    target="${template%.mustache}"
    ./colorscheme.rb "$scheme" | mustache - "$template" > "$target"
    chmod --reference="$template" "$target"
  done
}

setup_local_installation
build_packages
install_packages

